{% extends "base.html" %}

{% block title %}Review Extracted Frames - Player Appearance Tracker{% endblock %}

{% block head %}
<style>
    .frame-container {
        margin-bottom: 20px;
        border: 1px solid #ddd;
        border-radius: 5px;
        overflow: hidden;
    }
    .frame-image {
        max-width: 100%;
        height: auto;
    }
    .extracted-text {
        margin: 10px 0;
        max-height: 200px;
        overflow-y: auto;
    }
    .text-item {
        padding: 5px;
        margin-bottom: 5px;
        border-radius: 3px;
        border-left: 3px solid #ccc;
    }
    .confidence-high {
        border-left-color: #28a745;
    }
    .confidence-medium {
        border-left-color: #ffc107;
    }
    .confidence-low {
        border-left-color: #dc3545;
    }
    .nav-tabs .nav-link.active {
        font-weight: bold;
    }
    .spinner-border {
        width: 1rem;
        height: 1rem;
        margin-right: 0.5rem;
    }
    .player-select-container {
        margin-bottom: 15px;
    }
    .player-select-container label.text-primary {
        font-weight: bold;
        text-decoration: underline;
    }
    #processing-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        display: none;
    }
    .processing-content {
        background-color: white;
        padding: 30px;
        border-radius: 10px;
        text-align: center;
    }
    .processing-spinner {
        width: 3rem;
        height: 3rem;
        margin-bottom: 20px;
    }
    .player-name-input {
        min-width: 120px;
    }
    .input-group-sm {
        margin-bottom: 5px;
    }
    .add-name-btn {
        margin-top: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Review Extracted Frames</h1>
            <a href="{{ url_for('index') }}" class="btn btn-outline-primary">
                <i class="fas fa-arrow-left"></i> Back to Home
            </a>
        </div>
        
        <div class="alert alert-info">
            <i class="fas fa-info-circle"></i> Review the extracted frames below to confirm player appearances. You can select which players are detected in each frame.
        </div>
        
        <div class="alert alert-success">
            <i class="fas fa-check-circle"></i> Similar frames containing the same players have been automatically grouped. Only one representative frame from each group is shown, reducing redundancy while maintaining all unique player combinations.
            {% if frames_removed > 0 %}
            <br><strong>Deduplication:</strong> {{ frames_removed }} duplicate frames removed ({{ deduplication_percent }}% reduction).
            {% endif %}
        </div>
        
        <!-- Datalists for player name autocomplete -->
        <datalist id="home-players-list">
            {% for player in home_players %}
            <option value="{{ player.name }}">{{ player.name }}</option>
            {% endfor %}
        </datalist>
        
        <datalist id="away-players-list">
            {% for player in away_players %}
            <option value="{{ player.name }}">{{ player.name }}</option>
            {% endfor %}
        </datalist>
        
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <i class="fas fa-chart-bar"></i> Processing Details
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h5>{{ home_team_name }}</h5>
                        <p>Home Team</p>
                        <p>Home frames found: {{ home_frame_count }}</p>
                    </div>
                    <div class="col-md-6">
                        <h5>{{ away_team_name }}</h5>
                        <p>Away Team</p>
                        <p>Away frames found: {{ away_frame_count }}</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Team player selection -->
        <div class="row">
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <i class="fas fa-users"></i> {{ home_team_name }} Players
                    </div>
                    <div class="card-body player-selections">
                        <p class="mb-3">Select players who appeared in the match:</p>
                        {% for player in home_players %}
                        <div class="form-check player-select-container">
                            <input class="form-check-input home-player-check" type="checkbox" id="home-player-{{ player.id }}" data-player-id="{{ player.id }}">
                            <label class="form-check-label" for="home-player-{{ player.id }}">
                                {{ player.name }}
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <i class="fas fa-users"></i> {{ away_team_name }} Players
                    </div>
                    <div class="card-body player-selections">
                        <p class="mb-3">Select players who appeared in the match:</p>
                        {% for player in away_players %}
                        <div class="form-check player-select-container">
                            <input class="form-check-input away-player-check" type="checkbox" id="away-player-{{ player.id }}" data-player-id="{{ player.id }}">
                            <label class="form-check-label" for="away-player-{{ player.id }}">
                                {{ player.name }}
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tabs for home and away frames -->
        <ul class="nav nav-tabs mb-4" id="frameTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="home-tab" data-bs-toggle="tab" data-bs-target="#home-frames" 
                        type="button" role="tab" aria-controls="home-frames" aria-selected="true">
                    {{ home_team_name }} Frames ({{ home_frame_count }})
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="away-tab" data-bs-toggle="tab" data-bs-target="#away-frames" 
                        type="button" role="tab" aria-controls="away-frames" aria-selected="false">
                    {{ away_team_name }} Frames ({{ away_frame_count }})
                </button>
            </li>
        </ul>
        
        <!-- Frame content -->
        <div class="tab-content" id="frameTabsContent">
            <!-- Home team frames -->
            <div class="tab-pane fade show active" id="home-frames" role="tabpanel" aria-labelledby="home-tab">
                <div class="row">
                    {% for frame in session_data.frames %}
                    {% if frame.is_home %}
                    {% set frame_index = loop.index0 %}
                    <div class="col-md-6">
                        <div class="frame-container">
                            <div class="card">
                                <div class="card-header bg-success text-white">
                                    Home Frame #{{ loop.index }}
                                </div>
                                <div class="card-body">
                                    <img src="{{ url_for('static', filename='frames/' + session_id + '/' + frame.path.split('\\')[-1]) }}" 
                                         class="frame-image" 
                                         alt="Frame {{ loop.index }}"
                                         onerror="this.src='data:image/svg+xml;charset=UTF-8,%3Csvg width=\'100%\' height=\'225\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Crect width=\'100%\' height=\'100%\' fill=\'%23f8f9fa\'/%3E%3Ctext x=\'50%\' y=\'50%\' font-size=\'20\' text-anchor=\'middle\' alignment-baseline=\'middle\' fill=\'%23dee2e6\'%3ENo Image Found%3C/text%3E%3C/svg%3E'; this.onerror=null;">
                                    {% if not frame.path %}
                                    <div class="alert alert-warning mt-2">
                                        <i class="fas fa-exclamation-triangle"></i> Frame path missing
                                    </div>
                                    {% endif %}
                                    
                                    <div class="mt-3">
                                        <h6>Suggested Player Names:</h6>
                                        <div class="mb-3">
                                            {% if frame.suggested_names %}
                                                {% for name in frame.suggested_names %}
                                                <div class="d-inline-block me-1 mb-1">
                                                    <div class="input-group input-group-sm">
                                                        <input type="text" class="form-control player-name-input" 
                                                               value="{{ name }}" data-original="{{ name }}" 
                                                               data-frame-index="{{ frame_index }}"
                                                               data-name-index="{{ loop.index0 }}"
                                                               list="home-players-list"
                                                               data-team="home">
                                                        <button class="btn btn-outline-danger remove-name-btn" type="button">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                                {% endfor %}
                                                <div class="mt-2">
                                                    <button class="btn btn-sm btn-outline-success add-name-btn" 
                                                            data-frame-index="{{ frame_index }}" data-team="home">
                                                        <i class="fas fa-plus"></i> Add Name
                                                    </button>
                                                </div>
                                            {% else %}
                                                <p class="text-muted">No player names detected</p>
                                                <button class="btn btn-sm btn-outline-success add-name-btn" 
                                                        data-frame-index="{{ frame_index }}" data-team="home">
                                                    <i class="fas fa-plus"></i> Add Name
                                                </button>
                                            {% endif %}
                                        </div>
                                        <h6>Players to Select:</h6>
                                        <div>
                                            <button class="btn btn-sm btn-outline-primary select-all-home-btn" 
                                                    data-highlighted-names="{{ frame.suggested_names|join(',') }}">
                                                <i class="fas fa-check-double"></i> Select Players From This Frame
                                            </button>
                                            <div class="unmatched-players mt-2" style="display:none;">
                                                <small class="text-muted">Unmatched players: <span class="unmatched-names"></span></small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>
            
            <!-- Away team frames -->
            <div class="tab-pane fade" id="away-frames" role="tabpanel" aria-labelledby="away-tab">
                <div class="row">
                    {% for frame in session_data.frames %}
                    {% if frame.is_away %}
                    {% set frame_index = loop.index0 %}
                    <div class="col-md-6">
                        <div class="frame-container">
                            <div class="card">
                                <div class="card-header bg-danger text-white">
                                    Away Frame #{{ loop.index }}
                                </div>
                                <div class="card-body">
                                    <img src="{{ url_for('static', filename='frames/' + session_id + '/' + frame.path.split('\\')[-1]) }}" 
                                         class="frame-image" 
                                         alt="Frame {{ loop.index }}"
                                         onerror="this.src='data:image/svg+xml;charset=UTF-8,%3Csvg width=\'100%\' height=\'225\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Crect width=\'100%\' height=\'100%\' fill=\'%23f8f9fa\'/%3E%3Ctext x=\'50%\' y=\'50%\' font-size=\'20\' text-anchor=\'middle\' alignment-baseline=\'middle\' fill=\'%23dee2e6\'%3ENo Image Found%3C/text%3E%3C/svg%3E'; this.onerror=null;">
                                    {% if not frame.path %}
                                    <div class="alert alert-warning mt-2">
                                        <i class="fas fa-exclamation-triangle"></i> Frame path missing
                                    </div>
                                    {% endif %}
                                    
                                    <div class="mt-3">
                                        <h6>Suggested Player Names:</h6>
                                        <div class="mb-3">
                                            {% if frame.suggested_names %}
                                                {% for name in frame.suggested_names %}
                                                <div class="d-inline-block me-1 mb-1">
                                                    <div class="input-group input-group-sm">
                                                        <input type="text" class="form-control player-name-input" 
                                                               value="{{ name }}" data-original="{{ name }}" 
                                                               data-frame-index="{{ frame_index }}"
                                                               data-name-index="{{ loop.index0 }}"
                                                               list="away-players-list"
                                                               data-team="away">
                                                        <button class="btn btn-outline-danger remove-name-btn" type="button">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                                {% endfor %}
                                                <div class="mt-2">
                                                    <button class="btn btn-sm btn-outline-success add-name-btn" 
                                                            data-frame-index="{{ frame_index }}" data-team="away">
                                                        <i class="fas fa-plus"></i> Add Name
                                                    </button>
                                                </div>
                                            {% else %}
                                                <p class="text-muted">No player names detected</p>
                                                <button class="btn btn-sm btn-outline-success add-name-btn" 
                                                        data-frame-index="{{ frame_index }}" data-team="away">
                                                    <i class="fas fa-plus"></i> Add Name
                                                </button>
                                            {% endif %}
                                        </div>
                                        <h6>Players to Select:</h6>
                                        <div>
                                            <button class="btn btn-sm btn-outline-primary select-all-away-btn"
                                                    data-highlighted-names="{{ frame.suggested_names|join(',') }}">
                                                <i class="fas fa-check-double"></i> Select Players From This Frame
                                            </button>
                                            <div class="unmatched-players mt-2" style="display:none;">
                                                <small class="text-muted">Unmatched players: <span class="unmatched-names"></span></small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <div class="d-grid gap-2 col-md-6 mx-auto my-4">
            <button type="button" id="process-btn" class="btn btn-primary btn-lg">
                <i class="fas fa-save"></i> Save Player Appearances
            </button>
        </div>
    </div>
</div>

<!-- Processing overlay -->
<div id="processing-overlay">
    <div class="processing-content">
        <div class="spinner-border processing-spinner text-primary" role="status">
            <span class="visually-hidden">Processing...</span>
        </div>
        <h4>Processing Player Appearances</h4>
        <p id="processing-message">Please wait while we update the database...</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Store the session data and names for editing
    const sessionData = {{ session_data|tojson }};
    
    // Helper function to check name similarity
    function isNameSimilar(playerName, extractedText) {
        if (!extractedText) return false;
        
        playerName = playerName.toLowerCase();
        extractedText = extractedText.toLowerCase();
        
        // Direct match
        if (playerName === extractedText) return true;
        
        // Check if player name contains extracted text or vice versa
        if (playerName.includes(extractedText) || extractedText.includes(playerName)) return true;
        
        // Check individual parts of names
        const playerParts = playerName.split(' ');
        const extractedParts = extractedText.split(' ');
        
        // Check last names (assuming last part is the last name)
        if (playerParts.length > 0 && extractedParts.length > 0) {
            const playerLastName = playerParts[playerParts.length - 1];
            const extractedLastName = extractedParts[extractedParts.length - 1];
            
            if (playerLastName === extractedLastName) return true;
        }
        
        return false;
    }
    
    // Handle editing player names
    document.querySelectorAll('.player-name-input').forEach(input => {
        input.addEventListener('change', function() {
            const frameIndex = this.dataset.frameIndex;
            const nameIndex = this.dataset.nameIndex;
            const team = this.dataset.team;
            
            // Update in session data
            if (frameIndex && nameIndex) {
                if (sessionData.frames[frameIndex]) {
                    if (!sessionData.frames[frameIndex].edited_names) {
                        sessionData.frames[frameIndex].edited_names = [...sessionData.frames[frameIndex].suggested_names];
                    }
                    sessionData.frames[frameIndex].edited_names[nameIndex] = this.value;
                }
            }
            
            // When a name is entered, try to find an exact match in the player list
            if (team) {
                const playerValue = this.value.trim();
                const checkboxSelector = team === 'home' ? '.home-player-check' : '.away-player-check';
                
                document.querySelectorAll(checkboxSelector).forEach(checkbox => {
                    const label = checkbox.nextElementSibling;
                    const playerName = label.textContent.trim();
                    
                    // Exact match has priority
                    if (playerName.toLowerCase() === playerValue.toLowerCase()) {
                        checkbox.checked = true;
                        label.classList.add('text-primary', 'fw-bold');
                    }
                });
            }
            
            // Also run the standard matching for similarity
            highlightMatchingPlayers();
        });
        
        // Add input event for real-time suggestions
        input.addEventListener('input', function() {
            const team = this.dataset.team;
            const playerValue = this.value.trim();
            
            if (team && playerValue.length >= 2) {
                const checkboxSelector = team === 'home' ? '.home-player-check' : '.away-player-check';
                let foundExactMatch = false;
                
                document.querySelectorAll(checkboxSelector).forEach(checkbox => {
                    const label = checkbox.nextElementSibling;
                    const playerName = label.textContent.trim();
                    
                    // Highlight matching players in the list as user types
                    if (playerName.toLowerCase().includes(playerValue.toLowerCase())) {
                        label.classList.add('text-info');
                        
                        if (playerName.toLowerCase() === playerValue.toLowerCase()) {
                            foundExactMatch = true;
                        }
                    } else {
                        label.classList.remove('text-info');
                    }
                });
                
                // If found exact match, select it
                if (foundExactMatch) {
                    document.querySelectorAll(checkboxSelector).forEach(checkbox => {
                        const label = checkbox.nextElementSibling;
                        const playerName = label.textContent.trim();
                        
                        if (playerName.toLowerCase() === playerValue.toLowerCase()) {
                            checkbox.checked = true;
                            label.classList.add('text-primary', 'fw-bold');
                        }
                    });
                }
            }
        });
    });
    
    // Handle remove name button
    document.querySelectorAll('.remove-name-btn').forEach(button => {
        button.addEventListener('click', function() {
            const inputGroup = this.closest('.input-group');
            const input = inputGroup.querySelector('.player-name-input');
            const frameIndex = input.dataset.frameIndex;
            const nameIndex = input.dataset.nameIndex;
            
            // Remove from DOM
            inputGroup.closest('.d-inline-block').remove();
            
            // Remove from session data
            if (frameIndex && nameIndex) {
                if (sessionData.frames[frameIndex]) {
                    if (!sessionData.frames[frameIndex].edited_names) {
                        sessionData.frames[frameIndex].edited_names = [...sessionData.frames[frameIndex].suggested_names];
                    }
                    sessionData.frames[frameIndex].edited_names.splice(nameIndex, 1);
                    
                    // Update all subsequent name indices
                    const nameInputs = document.querySelectorAll(`.player-name-input[data-frame-index="${frameIndex}"]`);
                    nameInputs.forEach((nameInput, index) => {
                        if (index >= nameIndex) {
                            nameInput.dataset.nameIndex = index;
                        }
                    });
                }
            }
            
            // Update player selection
            highlightMatchingPlayers();
        });
    });
    
    // Handle add name button
    document.querySelectorAll('.add-name-btn').forEach(button => {
        button.addEventListener('click', function() {
            const frameIndex = this.dataset.frameIndex;
            const team = this.dataset.team;
            const container = this.closest('.mb-3');
            
            // Create new name input
            const newNameDiv = document.createElement('div');
            newNameDiv.className = 'd-inline-block me-1 mb-1';
            
            const nameIndex = sessionData.frames[frameIndex].edited_names ? 
                              sessionData.frames[frameIndex].edited_names.length : 
                              sessionData.frames[frameIndex].suggested_names.length;
            
            newNameDiv.innerHTML = `
                <div class="input-group input-group-sm">
                    <input type="text" class="form-control player-name-input" 
                           value="" data-original="" 
                           data-frame-index="${frameIndex}"
                           data-name-index="${nameIndex}"
                           list="${team}-players-list"
                           data-team="${team}">
                    <button class="btn btn-outline-danger remove-name-btn" type="button">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            // Insert before the Add Name button
            if (this.parentElement.className === 'mt-2') {
                container.insertBefore(newNameDiv, this.parentElement);
            } else {
                container.insertBefore(newNameDiv, this);
            }
            
            // Add event listeners to new elements
            const newInput = newNameDiv.querySelector('.player-name-input');
            newInput.addEventListener('change', function() {
                const frameIndex = this.dataset.frameIndex;
                const nameIndex = this.dataset.nameIndex;
                
                // Update in session data
                if (frameIndex && nameIndex) {
                    if (sessionData.frames[frameIndex]) {
                        if (!sessionData.frames[frameIndex].edited_names) {
                            sessionData.frames[frameIndex].edited_names = [...sessionData.frames[frameIndex].suggested_names];
                        }
                        sessionData.frames[frameIndex].edited_names[nameIndex] = this.value;
                    }
                }
                
                // Check for matching players and highlight them
                highlightMatchingPlayers();
            });
            
            const newRemoveBtn = newNameDiv.querySelector('.remove-name-btn');
            newRemoveBtn.addEventListener('click', function() {
                const inputGroup = this.closest('.input-group');
                const input = inputGroup.querySelector('.player-name-input');
                const frameIndex = input.dataset.frameIndex;
                const nameIndex = input.dataset.nameIndex;
                
                // Remove from DOM
                inputGroup.closest('.d-inline-block').remove();
                
                // Remove from session data
                if (frameIndex && nameIndex) {
                    if (sessionData.frames[frameIndex]) {
                        if (!sessionData.frames[frameIndex].edited_names) {
                            sessionData.frames[frameIndex].edited_names = [...sessionData.frames[frameIndex].suggested_names];
                        }
                        sessionData.frames[frameIndex].edited_names.splice(nameIndex, 1);
                    }
                }
                
                // Update player selection
                highlightMatchingPlayers();
            });
            
            // Initialize session data if needed
            if (sessionData.frames[frameIndex]) {
                if (!sessionData.frames[frameIndex].edited_names) {
                    sessionData.frames[frameIndex].edited_names = [...sessionData.frames[frameIndex].suggested_names];
                }
                sessionData.frames[frameIndex].edited_names.push("");
            }
            
            // Focus the new input
            newInput.focus();
        });
    });
    
    // Function to highlight matching players based on all frame names
    function highlightMatchingPlayers() {
        // Get all player names from all frames
        const allPlayerNames = [];
        document.querySelectorAll('.player-name-input').forEach(input => {
            if (input.value.trim()) {
                allPlayerNames.push(input.value.trim());
            }
        });
        
        // For each home player checkbox
        document.querySelectorAll('.home-player-check').forEach(checkbox => {
            const label = checkbox.nextElementSibling;
            const playerName = label.textContent.trim();
            
            // Check if player name appears in any name input
            let shouldBeChecked = false;
            for (const extractedText of allPlayerNames) {
                if (isNameSimilar(playerName, extractedText)) {
                    shouldBeChecked = true;
                    break;
                }
            }
            
            // Update checkbox and styling if it should be checked
            if (shouldBeChecked) {
                checkbox.checked = true;
                label.classList.add('text-primary', 'fw-bold');
            }
        });
        
        // For each away player checkbox
        document.querySelectorAll('.away-player-check').forEach(checkbox => {
            const label = checkbox.nextElementSibling;
            const playerName = label.textContent.trim();
            
            // Check if player name appears in any name input
            let shouldBeChecked = false;
            for (const extractedText of allPlayerNames) {
                if (isNameSimilar(playerName, extractedText)) {
                    shouldBeChecked = true;
                    break;
                }
            }
            
            // Update checkbox and styling if it should be checked
            if (shouldBeChecked) {
                checkbox.checked = true;
                label.classList.add('text-primary', 'fw-bold');
            }
        });
    }
    
    // Handle "Select Players From This Frame" buttons for home team
    document.querySelectorAll('.select-all-home-btn').forEach(button => {
        button.addEventListener('click', function() {
            // Get all current names from the frame
            const frameContainer = this.closest('.card-body');
            const extractedNames = Array.from(
                frameContainer.querySelectorAll('.player-name-input')
            ).map(input => input.value.trim()).filter(name => name);
            
            const unmatchedPlayers = [...extractedNames]; // Clone array to track unmatched names
            
            // For each home player checkbox - DON'T uncheck any
            document.querySelectorAll('.home-player-check').forEach(checkbox => {
                const label = checkbox.nextElementSibling;
                const playerName = label.textContent.trim();
                
                // Check if player name appears in any extracted text
                for (let i = 0; i < extractedNames.length; i++) {
                    const extractedText = extractedNames[i];
                    if (isNameSimilar(playerName, extractedText)) {
                        checkbox.checked = true; // Only check, never uncheck
                        // Highlight the matched player
                        label.classList.add('text-primary', 'fw-bold');
                        
                        // Remove from unmatched players
                        const index = unmatchedPlayers.indexOf(extractedText);
                        if (index !== -1) {
                            unmatchedPlayers.splice(index, 1);
                        }
                        
                        break;
                    }
                }
            });
            
            // Display unmatched players
            const unmatchedPlayersDiv = this.nextElementSibling;
            const unmatchedNamesSpan = unmatchedPlayersDiv.querySelector('.unmatched-names');
            
            if (unmatchedPlayers.length > 0) {
                unmatchedNamesSpan.textContent = unmatchedPlayers.join(', ');
                unmatchedPlayersDiv.style.display = 'block';
            } else {
                unmatchedPlayersDiv.style.display = 'none';
            }
        });
    });
    
    // Handle "Select Players From This Frame" buttons for away team
    document.querySelectorAll('.select-all-away-btn').forEach(button => {
        button.addEventListener('click', function() {
            // Get all current names from the frame
            const frameContainer = this.closest('.card-body');
            const extractedNames = Array.from(
                frameContainer.querySelectorAll('.player-name-input')
            ).map(input => input.value.trim()).filter(name => name);
            
            const unmatchedPlayers = [...extractedNames]; // Clone array to track unmatched names
            
            // For each away player checkbox - DON'T uncheck any
            document.querySelectorAll('.away-player-check').forEach(checkbox => {
                const label = checkbox.nextElementSibling;
                const playerName = label.textContent.trim();
                
                // Check if player name appears in any extracted text
                for (let i = 0; i < extractedNames.length; i++) {
                    const extractedText = extractedNames[i];
                    if (isNameSimilar(playerName, extractedText)) {
                        checkbox.checked = true; // Only check, never uncheck
                        // Highlight the matched player
                        label.classList.add('text-primary', 'fw-bold');
                        
                        // Remove from unmatched players
                        const index = unmatchedPlayers.indexOf(extractedText);
                        if (index !== -1) {
                            unmatchedPlayers.splice(index, 1);
                        }
                        
                        break;
                    }
                }
            });
            
            // Display unmatched players
            const unmatchedPlayersDiv = this.nextElementSibling;
            const unmatchedNamesSpan = unmatchedPlayersDiv.querySelector('.unmatched-names');
            
            if (unmatchedPlayers.length > 0) {
                unmatchedNamesSpan.textContent = unmatchedPlayers.join(', ');
                unmatchedPlayersDiv.style.display = 'block';
            } else {
                unmatchedPlayersDiv.style.display = 'none';
            }
        });
    });
    
    // Call once on page load to highlight matching players
    highlightMatchingPlayers();
    
    // Handle "Save Player Appearances" button
    document.getElementById('process-btn').addEventListener('click', function() {
        // Show processing overlay
        document.getElementById('processing-overlay').style.display = 'flex';
        
        // Collect selected home players
        const selectedHomePlayers = [];
        document.querySelectorAll('.home-player-check:checked').forEach(checkbox => {
            selectedHomePlayers.push(checkbox.dataset.playerId);
        });
        
        // Collect selected away players
        const selectedAwayPlayers = [];
        document.querySelectorAll('.away-player-check:checked').forEach(checkbox => {
            selectedAwayPlayers.push(checkbox.dataset.playerId);
        });
        
        // Collect all edited player names for future reference
        const editedFrames = {};
        for (let i = 0; i < sessionData.frames.length; i++) {
            if (sessionData.frames[i].edited_names) {
                editedFrames[i] = sessionData.frames[i].edited_names;
            }
        }
        
        // Prepare data for submission
        const playerData = {
            home_players: selectedHomePlayers,
            away_players: selectedAwayPlayers,
            edited_frames: editedFrames
        };
        
        // Submit data to server
        fetch(`/review/${sessionData.session_id}/process`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(playerData),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Redirect to results page
                window.location.href = data.redirect_url;
            } else {
                // Hide overlay and show error
                document.getElementById('processing-overlay').style.display = 'none';
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            document.getElementById('processing-overlay').style.display = 'none';
            alert('Error processing request: ' + error);
        });
    });
});
</script>
{% endblock %} 