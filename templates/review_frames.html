{% extends 'base.html' %}

{% block title %}Review Extracted Players{% endblock %}

{% block content %}
<div class="container my-4">
    <h1 class="mb-4">Review Extracted Players</h1>
    
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h3 class="card-title">Match Information</h3>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <strong>Home Team:</strong> {{ home_team }}
                </div>
                <div class="col-md-4">
                    <strong>Away Team:</strong> {{ away_team }}
                </div>
                <div class="col-md-4">
                    <strong>Match Day:</strong> {{ match_day }}
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-md-6">
                    <strong>Total Frames:</strong> {{ total_frames }}
                </div>
                <div class="col-md-6">
                    <strong>Players Detected:</strong> {{ total_home_players|length + total_away_players|length }}
                </div>
            </div>
        </div>
    </div>
    
    <div class="alert alert-info">
        <p><i class="fas fa-info-circle"></i> Review the extracted player names below. You can edit the names before finalizing the results.</p>
        <p>For each frame, you can:</p>
        <ul>
            <li>Add new players (separate with commas or new lines)</li>
            <li>Edit existing player names</li>
            <li>Remove players by deleting their names</li>
        </ul>
    </div>
    
    <!-- Live Summary Section -->
    <div class="card mb-4 sticky-top" style="top: 10px; z-index: 100;">
        <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
            <h3 class="card-title mb-0">Live Player Summary</h3>
            <button type="button" class="btn btn-sm btn-light" id="toggleSummary">
                <span id="summary-expand-text" style="display: none;">Show</span>
                <span id="summary-collapse-text">Hide</span>
            </button>
        </div>
        <div class="card-body" id="liveSummaryBody">
            <div class="row">
                <div class="col-md-6">
                    <h4>{{ home_team }} (<span id="home-player-count">0</span>)</h4>
                    <ul class="list-group" id="live-home-players">
                        <!-- Live updated home players will appear here -->
                    </ul>
                </div>
                <div class="col-md-6">
                    <h4>{{ away_team }} (<span id="away-player-count">0</span>)</h4>
                    <ul class="list-group" id="live-away-players">
                        <!-- Live updated away players will appear here -->
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <form action="{% if is_batch %}{{ url_for('batch_update_player_names', video_id=video_id) }}{% else %}{{ url_for('update_player_names') }}{% endif %}" method="post">
        {% set frames_shown = 0 %}
        {% set unique_player_sets = {} %}
        
        {# First, group frames by unique combinations of players #}
        {% for frame in frames %}
            {% set home_players = home_players_by_frame.get(frame, [])|sort|join(',') %}
            {% set away_players = away_players_by_frame.get(frame, [])|sort|join(',') %}
            {% set player_key = home_players + '|' + away_players %}
            
            {% if home_players or away_players %}
                {% if player_key not in unique_player_sets %}
                    {% if unique_player_sets.update({player_key: frame}) %}{% endif %}
                {% endif %}
            {% endif %}
        {% endfor %}
        
        {# Then display only one frame for each unique player combination #}
        {% for player_key, frame in unique_player_sets.items() %}
            {% set base_frame_id = frame.split('/')[-1] %}
            {% if '.' in base_frame_id %}
                {% set base_frame_id = base_frame_id.split('.')[0] %}
            {% endif %}
            {% set frames_shown = frames_shown + 1 %}
            
            <div class="card mb-4 frame-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Frame: {{ base_frame_id }}</h5>
                    <button type="button" class="btn btn-sm btn-outline-primary toggle-frame-btn">
                        <span class="expand-text">Expand</span>
                        <span class="collapse-text" style="display:none;">Collapse</span>
                    </button>
                </div>
                
                <div class="card-body frame-content" style="display:none;">
                    <div class="row">
                        <div class="col-md-6">
                            <img src="{{ frame }}" class="img-fluid mb-3" alt="Frame">
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-4">
                                <h5>Home Team Players ({{ home_team }})</h5>
                                <textarea class="form-control player-textarea home-players" name="home_players_{{ base_frame_id }}" rows="4" placeholder="Enter home team players (one per line or comma-separated)" data-frame-id="{{ base_frame_id }}">{{ home_players_by_frame.get(frame, [])|join('\n') }}</textarea>
                            </div>
                            
                            <div class="mb-4">
                                <h5>Away Team Players ({{ away_team }})</h5>
                                <textarea class="form-control player-textarea away-players" name="away_players_{{ base_frame_id }}" rows="4" placeholder="Enter away team players (one per line or comma-separated)" data-frame-id="{{ base_frame_id }}">{{ away_players_by_frame.get(frame, [])|join('\n') }}</textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {% endfor %}
        
        {% if frames_shown == 0 %}
            <div class="alert alert-warning">
                <p><i class="fas fa-exclamation-triangle"></i> No frames with player names were found.</p>
                <p>Please try processing the video again or check if the video contains player ratings screens.</p>
            </div>
        {% else %}
            <div class="alert alert-success">
                <p><i class="fas fa-check-circle"></i> Showing {{ frames_shown }} unique player combinations from {{ total_frames }} total frames.</p>
                <p>Duplicate frames with the same players have been filtered out.</p>
            </div>
        {% endif %}
        
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <h3 class="card-title">Initial Player Summary</h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h4>{{ home_team }} ({{ total_home_players|length }})</h4>
                        <ul class="list-group">
                            {% for player in total_home_players %}
                                <li class="list-group-item">{{ player }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h4>{{ away_team }} ({{ total_away_players|length }})</h4>
                        <ul class="list-group">
                            {% for player in total_away_players %}
                                <li class="list-group-item">{{ player }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="d-flex justify-content-between mb-5">
            {% if is_batch %}
                <a href="{{ url_for('batch_results', video_id=video_id) }}" class="btn btn-secondary">Cancel</a>
            {% else %}
                <a href="{{ url_for('home') }}" class="btn btn-secondary">Cancel</a>
            {% endif %}
            <button type="submit" class="btn btn-primary">Save Changes and Continue</button>
        </div>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Handle expand/collapse of frames
        const toggleButtons = document.querySelectorAll('.toggle-frame-btn');
        
        toggleButtons.forEach(button => {
            button.addEventListener('click', function() {
                const card = this.closest('.frame-card');
                const content = card.querySelector('.frame-content');
                const expandText = this.querySelector('.expand-text');
                const collapseText = this.querySelector('.collapse-text');
                
                if (content.style.display === 'none') {
                    content.style.display = 'block';
                    expandText.style.display = 'none';
                    collapseText.style.display = 'inline';
                } else {
                    content.style.display = 'none';
                    expandText.style.display = 'inline';
                    collapseText.style.display = 'none';
                }
            });
        });
        
        // Auto-expand first few frames
        const frameCards = document.querySelectorAll('.frame-card');
        const maxAutoExpand = 3; // Maximum number of frames to auto-expand
        
        for (let i = 0; i < Math.min(frameCards.length, maxAutoExpand); i++) {
            const button = frameCards[i].querySelector('.toggle-frame-btn');
            button.click();
        }
        
        // Toggle live summary
        const toggleSummary = document.getElementById('toggleSummary');
        const liveSummaryBody = document.getElementById('liveSummaryBody');
        const summaryExpandText = document.getElementById('summary-expand-text');
        const summaryCollapseText = document.getElementById('summary-collapse-text');
        
        toggleSummary.addEventListener('click', function() {
            if (liveSummaryBody.style.display === 'none') {
                liveSummaryBody.style.display = 'block';
                summaryExpandText.style.display = 'none';
                summaryCollapseText.style.display = 'inline';
            } else {
                liveSummaryBody.style.display = 'none';
                summaryExpandText.style.display = 'inline';
                summaryCollapseText.style.display = 'none';
            }
        });
        
        // Track player names and update summary in real-time
        const homePlayersList = document.getElementById('live-home-players');
        const awayPlayersList = document.getElementById('live-away-players');
        const homePlayerCount = document.getElementById('home-player-count');
        const awayPlayerCount = document.getElementById('away-player-count');
        
        // Function to split textarea content into player names
        function parsePlayerNames(text) {
            // Split by commas or newlines
            return text.split(/[,\n]/)
                .map(name => name.trim())
                .filter(name => name.length > 0);
        }
        
        // Function to update the live summary
        function updateLiveSummary() {
            // Get all player names from all textareas
            const homeTextareas = document.querySelectorAll('.player-textarea.home-players');
            const awayTextareas = document.querySelectorAll('.player-textarea.away-players');
            
            // Create sets to store unique player names
            const homePlayersSet = new Set();
            const awayPlayersSet = new Set();
            
            // Process home players
            homeTextareas.forEach(textarea => {
                const players = parsePlayerNames(textarea.value);
                players.forEach(player => homePlayersSet.add(player));
            });
            
            // Process away players
            awayTextareas.forEach(textarea => {
                const players = parsePlayerNames(textarea.value);
                players.forEach(player => awayPlayersSet.add(player));
            });
            
            // Convert sets to sorted arrays
            const homePlayers = Array.from(homePlayersSet).sort();
            const awayPlayers = Array.from(awayPlayersSet).sort();
            
            // Update the player count
            homePlayerCount.textContent = homePlayers.length;
            awayPlayerCount.textContent = awayPlayers.length;
            
            // Update the lists
            homePlayersList.innerHTML = '';
            awayPlayersList.innerHTML = '';
            
            homePlayers.forEach(player => {
                const li = document.createElement('li');
                li.className = 'list-group-item';
                li.textContent = player;
                homePlayersList.appendChild(li);
            });
            
            awayPlayers.forEach(player => {
                const li = document.createElement('li');
                li.className = 'list-group-item';
                li.textContent = player;
                awayPlayersList.appendChild(li);
            });
        }
        
        // Add event listeners to all textareas
        const playerTextareas = document.querySelectorAll('.player-textarea');
        playerTextareas.forEach(textarea => {
            textarea.addEventListener('input', updateLiveSummary);
        });
        
        // Initial update
        updateLiveSummary();
    });
</script>
{% endblock %} 