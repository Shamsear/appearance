{% extends "base.html" %}

{% block title %}Processing Video - Player Appearance Tracker{% endblock %}

{% block head %}
<style>
    .processing-container {
        text-align: center;
        padding: 40px 20px;
    }
    .processing-spinner {
        width: 5rem;
        height: 5rem;
        margin-bottom: 30px;
    }
    .processing-title {
        margin-bottom: 20px;
    }
    .processing-steps {
        max-width: 500px;
        margin: 0 auto;
        text-align: left;
    }
    .step {
        padding: 12px 15px;
        margin-bottom: 15px;
        border-radius: 8px;
        background-color: #f8f9fa;
        display: flex;
        align-items: center;
    }
    .step-pending {
        color: #6c757d;
        border-left: 4px solid #6c757d;
    }
    .step-active {
        color: #0d6efd;
        border-left: 4px solid #0d6efd;
        background-color: #f0f7ff;
    }
    .step-completed {
        color: #198754;
        border-left: 4px solid #198754;
    }
    .step-icon {
        margin-right: 15px;
        font-size: 1.25rem;
    }
    .loading-bar {
        height: 5px;
        background-color: #e9ecef;
        border-radius: 5px;
        margin: 30px 0;
        overflow: hidden;
        position: relative;
    }
    .loading-bar-progress {
        position: absolute;
        height: 100%;
        background-color: #0d6efd;
        border-radius: 5px;
        width: 0%;
        animation: load-animation 2s ease-in-out infinite;
    }
    .step-spinner {
        width: 1.5rem;
        height: 1.5rem;
    }
    @keyframes load-animation {
        0% { width: 0%; }
        50% { width: 75%; }
        100% { width: 100%; }
    }
    .detailed-progress {
        max-height: 200px;
        overflow-y: auto;
        font-family: monospace;
        font-size: 0.85rem;
        background-color: #f8f9fa;
        border-radius: 5px;
        padding: 10px;
        margin-top: 20px;
        text-align: left;
        border: 1px solid #e9ecef;
    }
    .progress-info {
        display: flex;
        justify-content: space-between;
        margin-top: 10px;
    }
    .progress-stat {
        background-color: #f8f9fa;
        border-radius: 5px;
        padding: 8px 12px;
        flex: 1;
        margin: 0 5px;
        text-align: center;
        border: 1px solid #e9ecef;
    }
    .progress-stat-title {
        font-size: 0.8rem;
        color: #6c757d;
        margin-bottom: 2px;
    }
    .progress-stat-value {
        font-size: 1.1rem;
        font-weight: bold;
    }
    .log-entry {
        margin-bottom: 4px;
        padding-left: 10px;
        border-left: 2px solid transparent;
    }
    .log-entry.info {
        border-left-color: #0d6efd;
    }
    .log-entry.success {
        border-left-color: #198754;
    }
    .log-entry.warning {
        border-left-color: #ffc107;
    }
    .log-entry.error {
        border-left-color: #dc3545;
        color: #dc3545;
    }
    .step-details {
        font-size: 0.8rem;
        color: #6c757d;
        margin-top: 4px;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body processing-container">
                <div class="spinner-border processing-spinner text-primary" role="status">
                    <span class="visually-hidden">Processing...</span>
                </div>
                
                <h2 class="processing-title">Processing Your Video</h2>
                <p class="text-muted mb-4">Please wait while we process your video. This may take a few minutes depending on the file size.</p>
                
                <div class="loading-bar">
                    <div class="loading-bar-progress"></div>
                </div>
                
                <!-- Processing statistics -->
                <div class="progress-info mb-4">
                    <div class="progress-stat">
                        <div class="progress-stat-title">ELAPSED TIME</div>
                        <div class="progress-stat-value" id="elapsed-time">0s</div>
                    </div>
                    <div class="progress-stat">
                        <div class="progress-stat-title">FRAMES PROCESSED</div>
                        <div class="progress-stat-value" id="frames-processed">0</div>
                    </div>
                    <div class="progress-stat">
                        <div class="progress-stat-title">PLAYER FRAMES</div>
                        <div class="progress-stat-value" id="player-frames">0</div>
                    </div>
                </div>
                
                <div class="processing-steps">
                    <div id="step1" class="step step-active">
                        <div class="step-icon">
                            <div class="spinner-border step-spinner text-primary" role="status">
                                <span class="visually-hidden">Processing...</span>
                            </div>
                        </div>
                        <div class="step-content">
                            <div><strong>Step 1:</strong> Uploading video file</div>
                            <div class="step-details" id="step1-details"></div>
                        </div>
                    </div>
                    
                    <div id="step2" class="step step-pending">
                        <div class="step-icon">
                            <i class="fas fa-film"></i>
                        </div>
                        <div class="step-content">
                            <div><strong>Step 2:</strong> Extracting frames</div>
                            <div class="step-details" id="step2-details"></div>
                        </div>
                    </div>
                    
                    <div id="step3" class="step step-pending">
                        <div class="step-icon">
                            <i class="fas fa-search"></i>
                        </div>
                        <div class="step-content">
                            <div><strong>Step 3:</strong> Identifying player rating screens</div>
                            <div class="step-details" id="step3-details"></div>
                        </div>
                    </div>
                    
                    <div id="step4" class="step step-pending">
                        <div class="step-icon">
                            <i class="fas fa-font"></i>
                        </div>
                        <div class="step-content">
                            <div><strong>Step 4:</strong> Extracting player names with OCR</div>
                            <div class="step-details" id="step4-details"></div>
                        </div>
                    </div>
                    
                    <div id="step5" class="step step-pending">
                        <div class="step-icon">
                            <i class="fas fa-database"></i>
                        </div>
                        <div class="step-content">
                            {% if process_type == 'review' %}
                            <div><strong>Step 5:</strong> Preparing frame review page</div>
                            {% else %}
                            <div><strong>Step 5:</strong> Updating player appearances in database</div>
                            {% endif %}
                            <div class="step-details" id="step5-details"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Detailed progress log -->
                <div class="detailed-progress">
                    <div id="progress-log">
                        <div class="log-entry info">Starting processing...</div>
                    </div>
                </div>
                
                <p class="mt-4 text-muted"><small>Do not close this browser window. You will be redirected automatically once processing is complete.</small></p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const processType = "{{ process_type }}";
    const uploadId = "{{ upload_id }}";
    let lastStep = 0;
    let retryCount = 0;
    let isProcessingComplete = false;
    let startTime = Date.now();
    let totalFrames = 0;
    let playerFrames = 0;
    
    // Add a connection status indicator to the page
    const statusIndicator = document.createElement('div');
    statusIndicator.className = 'alert alert-info mt-3 d-none';
    statusIndicator.id = 'connection-status';
    statusIndicator.innerHTML = '<i class="fas fa-sync fa-spin"></i> Checking processing status...';
    document.querySelector('.loading-bar').insertAdjacentElement('afterend', statusIndicator);
    
    // Helper function to add a log entry
    function addLogEntry(message, type = 'info') {
        const log = document.getElementById('progress-log');
        const entry = document.createElement('div');
        entry.className = `log-entry ${type}`;
        entry.textContent = message;
        log.appendChild(entry);
        
        // Auto-scroll to bottom
        log.scrollTop = log.scrollHeight;
    }
    
    // Function to update UI when a step is completed
    function completeStep(stepNum) {
        if (stepNum <= lastStep) return; // Skip if already completed
        
        // Mark previous step as completed if not already
        if (stepNum > 1 && lastStep < stepNum - 1) {
            for (let i = lastStep + 1; i < stepNum; i++) {
                const prevStep = document.getElementById(`step${i}`);
                prevStep.classList.remove('step-active', 'step-pending');
                prevStep.classList.add('step-completed');
                
                // Replace spinner with check icon
                const prevIcon = prevStep.querySelector('.step-icon');
                prevIcon.innerHTML = '<i class="fas fa-check-circle"></i>';
            }
        }
        
        const step = document.getElementById(`step${stepNum}`);
        
        // If this is a new active step
        if (!step.classList.contains('step-completed')) {
            // Remove active class from any other step
            document.querySelectorAll('.step-active').forEach(el => {
                el.classList.remove('step-active');
                el.classList.add('step-pending');
                // Reset icon if it's not already completed
                if (!el.classList.contains('step-completed')) {
                    const icon = el.querySelector('.step-icon');
                    icon.innerHTML = `<i class="fas fa-${getIconForStep(parseInt(el.id.replace('step', '')))}"></i>`;
                }
            });
            
            // Make this step active
            step.classList.remove('step-pending');
            step.classList.add('step-active');
            
            // Add spinner to this step
            const icon = step.querySelector('.step-icon');
            icon.innerHTML = '<div class="spinner-border step-spinner text-primary" role="status"><span class="visually-hidden">Processing...</span></div>';
            
            // Add log entry for the new step
            let stepText = '';
            if (stepNum === 1) stepText = "Uploading video file...";
            else if (stepNum === 2) stepText = "Extracting frames from video...";
            else if (stepNum === 3) stepText = "Scanning frames for player ratings...";
            else if (stepNum === 4) stepText = "Processing OCR text to extract player names...";
            else if (stepNum === 5) {
                if (processType === 'review') {
                    stepText = "Preparing review page with extracted frames...";
                } else {
                    stepText = "Updating player appearances in database...";
                }
            }
            
            addLogEntry(`Starting Step ${stepNum}: ${stepText}`);
        }
        
        lastStep = stepNum;
    }
    
    // Function to get icon for a step
    function getIconForStep(stepNum) {
        switch (stepNum) {
            case 1: return 'upload';
            case 2: return 'film';
            case 3: return 'search';
            case 4: return 'font';
            case 5: return 'database';
            default: return 'circle';
        }
    }
    
    // Function to mark a step as complete
    function markStepComplete(stepNum) {
        const step = document.getElementById(`step${stepNum}`);
        step.classList.remove('step-active', 'step-pending');
        step.classList.add('step-completed');
        
        // Replace spinner with check icon
        const icon = step.querySelector('.step-icon');
        icon.innerHTML = '<i class="fas fa-check-circle"></i>';
        
        lastStep = Math.max(lastStep, stepNum);
        
        // Add log entry
        let stepText = '';
        if (stepNum === 1) stepText = "Video upload completed";
        else if (stepNum === 2) stepText = "Frame extraction completed";
        else if (stepNum === 3) stepText = "Player rating screen identification completed";
        else if (stepNum === 4) stepText = "Player name extraction completed";
        else if (stepNum === 5) {
            if (processType === 'review') {
                stepText = "Review page preparation completed";
            } else {
                stepText = "Player appearances updated in database";
            }
        }
        
        addLogEntry(`Completed Step ${stepNum}: ${stepText}`, 'success');
    }
    
    // Function to update step details
    function updateStepDetails(stepNum, details) {
        const detailsEl = document.getElementById(`step${stepNum}-details`);
        if (detailsEl) {
            detailsEl.textContent = details;
        }
    }
    
    // Function to update processing statistics
    function updateStats(data) {
        // Update elapsed time
        const elapsedSeconds = Math.floor((Date.now() - startTime) / 1000);
        const minutes = Math.floor(elapsedSeconds / 60);
        const seconds = elapsedSeconds % 60;
        document.getElementById('elapsed-time').textContent = `${minutes}m ${seconds}s`;
        
        // Update frames processed
        if (data.frames_processed && data.frames_processed > totalFrames) {
            totalFrames = data.frames_processed;
            document.getElementById('frames-processed').textContent = totalFrames;
        }
        
        // Update player frames
        if (data.player_frames && data.player_frames > playerFrames) {
            playerFrames = data.player_frames;
            document.getElementById('player-frames').textContent = playerFrames;
        }
    }
    
    // Function to handle server errors
    function handleServerError(error) {
        retryCount++;
        console.error('Error checking status:', error);
        
        if (retryCount > 10) {
            // After multiple retries, show error message
            document.querySelector('.processing-title').textContent = 'Connection Error';
            document.querySelector('.loading-bar-progress').style.backgroundColor = '#dc3545';
            document.querySelector('.loading-bar-progress').style.animation = 'none';
            
            addLogEntry('Connection to server lost. Please check your network connection.', 'error');
            
            const errorMessage = document.createElement('div');
            errorMessage.className = 'alert alert-warning mt-4';
            errorMessage.innerHTML = `
                <i class="fas fa-exclamation-circle"></i> 
                We're having trouble connecting to the server to check your processing status.<br>
                <div class="mt-2">
                    <button id="retry-btn" class="btn btn-primary me-2">Retry Connection</button>
                    <a href="/" class="btn btn-outline-secondary">Return to Home</a>
                </div>
            `;
            
            // Only add the message if it doesn't exist yet
            if (!document.getElementById('error-message')) {
                errorMessage.id = 'error-message';
                document.querySelector('.progress-info').insertAdjacentElement('afterend', errorMessage);
                
                // Add event listener to retry button
                document.getElementById('retry-btn').addEventListener('click', function() {
                    // Reset retry count
                    retryCount = 0;
                    
                    // Remove error message
                    document.getElementById('error-message').remove();
                    
                    // Reset UI
                    document.querySelector('.processing-title').textContent = 'Processing Your Video';
                    document.querySelector('.loading-bar-progress').style.backgroundColor = '#0d6efd';
                    document.querySelector('.loading-bar-progress').style.animation = 'load-animation 2s ease-in-out infinite';
                    
                    addLogEntry('Retrying connection to server...', 'info');
                    
                    // Restart status checking
                    checkStatus();
                });
            }
        } else {
            // Show connection status message
            const statusEl = document.getElementById('connection-status');
            statusEl.classList.remove('d-none');
            statusEl.classList.remove('alert-info');
            statusEl.classList.add('alert-warning');
            statusEl.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Connection issue. Retrying in 3 seconds... (Attempt ${retryCount}/10)`;
            
            addLogEntry(`Connection issue. Retrying (${retryCount}/10)...`, 'warning');
            
            // Try again with increasing delay based on retry count
            setTimeout(checkStatus, 3000);
        }
    }
    
    // Function to check processing status
    function checkStatus() {
        if (isProcessingComplete) return;
        
        // Show checking status
        const statusEl = document.getElementById('connection-status');
        if (retryCount > 0) {
            statusEl.classList.remove('d-none');
            statusEl.innerHTML = '<i class="fas fa-sync fa-spin"></i> Checking processing status...';
        }
        
        fetch(`/upload-status/${uploadId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Server responded with status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // Reset retry count on successful response
                retryCount = 0;
                
                // Hide connection status on success
                document.getElementById('connection-status').classList.add('d-none');
                
                // Update processing statistics
                updateStats(data);
                
                if (data.current_step > 0) {
                    // Mark previous steps as completed
                    for (let i = 1; i < data.current_step; i++) {
                        markStepComplete(i);
                    }
                    
                    // Set current step as active
                    completeStep(data.current_step);
                    
                    // Update step details if provided
                    if (data.step_details) {
                        for (const [step, details] of Object.entries(data.step_details)) {
                            updateStepDetails(step, details);
                        }
                    }
                    
                    // Update specific step details based on data
                    if (data.frames_processed) {
                        updateStepDetails(2, `Processed ${data.frames_processed} frames`);
                    }
                    
                    if (data.player_frames) {
                        updateStepDetails(3, `Found ${data.player_frames} player rating frames`);
                    }
                    
                    if (data.original_frame_count && data.deduplicated_frame_count) {
                        const frameReduction = data.original_frame_count - data.deduplicated_frame_count;
                        const reductionPercent = Math.round((frameReduction / data.original_frame_count) * 100);
                        
                        if (frameReduction > 0) {
                            updateStepDetails(5, `Deduplicated ${frameReduction} frames (${reductionPercent}% reduction)`);
                            addLogEntry(`Deduplicated ${frameReduction} similar frames (${reductionPercent}% reduction)`, 'success');
                        }
                    }
                    
                    // Log messages if available
                    if (data.log_messages && Array.isArray(data.log_messages)) {
                        data.log_messages.forEach(msg => {
                            addLogEntry(msg.message, msg.type || 'info');
                        });
                    }
                    
                    // Handle status
                    if (data.status === 'complete') {
                        isProcessingComplete = true;
                        
                        // Mark final step as complete
                        markStepComplete(5);
                        
                        // Add success message
                        document.querySelector('.processing-title').textContent = 'Processing Complete!';
                        addLogEntry('Processing completed successfully!', 'success');
                        
                        // Wait a moment before redirecting
                        setTimeout(() => {
                            if (data.process_type === 'review') {
                                addLogEntry(`Redirecting to review page for session ${data.session_id}...`, 'info');
                                window.location.href = `/review/${data.session_id}`;
                            } else {
                                addLogEntry('Redirecting to results page...', 'info');
                                window.location.href = '/results';
                            }
                        }, 1500);
                    } else if (data.status === 'error') {
                        isProcessingComplete = true;
                        
                        // Show error UI
                        document.querySelector('.processing-title').textContent = 'Processing Error';
                        document.querySelector('.loading-bar-progress').style.backgroundColor = '#dc3545';
                        document.querySelector('.loading-bar-progress').style.width = '100%';
                        document.querySelector('.loading-bar-progress').style.animation = 'none';
                        
                        addLogEntry(`Error: ${data.error}`, 'error');
                        
                        // Add error message
                        const messageEl = document.createElement('div');
                        messageEl.className = 'alert alert-danger mt-4';
                        messageEl.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Error: ${data.error}<br>
                            <a href="/" class="btn btn-outline-danger mt-2">Return to Home</a>`;
                        document.querySelector('.detailed-progress').insertAdjacentElement('beforebegin', messageEl);
                    } else {
                        // If not complete, check again in 2 seconds
                        setTimeout(checkStatus, 2000);
                    }
                } else {
                    // If processing hasn't started yet, check again in 1 second
                    setTimeout(checkStatus, 1000);
                }
            })
            .catch(error => {
                handleServerError(error);
            });
    }
    
    // Start checking status
    checkStatus();
});
</script>
{% endblock %} 