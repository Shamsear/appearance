<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Batch Processing - Player Extraction App</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        body {
            padding-top: 2rem;
            background-color: #f5f5f5;
        }
        .batch-container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 2rem;
        }
        .file-input {
            padding: 1rem;
            border: 2px dashed #ddd;
            border-radius: 5px;
            text-align: center;
            margin-bottom: 1rem;
        }
        .queue-section {
            margin-top: 2rem;
            padding: 1rem;
            border: 1px solid #eee;
            border-radius: 5px;
        }
        .status-badge {
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
        }
        .pending {
            background-color: #f8f9fa;
            color: #6c757d;
        }
        .processing {
            background-color: #cff4fc;
            color: #055160;
        }
        .completed {
            background-color: #d1e7dd;
            color: #0f5132;
        }
        .error {
            background-color: #f8d7da;
            color: #842029;
        }
        .progress-bar {
            transition: width 0.3s;
        }
        .nav-tabs {
            margin-bottom: 1rem;
        }
        .action-buttons {
            white-space: nowrap;
        }
        .video-count {
            font-size: 0.9rem;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="batch-container">
            <div class="header">
                <h1>Batch Processing</h1>
                <p class="text-muted">Upload multiple videos for processing</p>
                <a href="{{ url_for('index') }}" class="btn btn-outline-secondary btn-sm">
                    <i class="bi bi-arrow-left"></i> Back to Single Upload
                </a>
            </div>
            
            {% with messages = get_flashed_messages() %}
                {% if messages %}
                    {% for message in messages %}
                        <div class="alert alert-warning">{{ message }}</div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
            
            <ul class="nav nav-tabs" id="batchTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload" type="button" role="tab" aria-controls="upload" aria-selected="true">Upload Videos</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="queue-tab" data-bs-toggle="tab" data-bs-target="#queue" type="button" role="tab" aria-controls="queue" aria-selected="false">
                        Queue <span class="badge bg-secondary">{{ queue_status.total }}</span>
                    </button>
                </li>
            </ul>
            
            <div class="tab-content" id="batchTabsContent">
                <!-- Upload Tab -->
                <div class="tab-pane fade show active" id="upload" role="tabpanel" aria-labelledby="upload-tab">
                    <form action="{{ url_for('batch_add') }}" method="post" enctype="multipart/form-data" id="batchUploadForm">
                        <div class="mb-3">
                            <label for="files" class="form-label">Upload Multiple Match Videos</label>
                            <div class="file-input">
                                <input type="file" class="form-control" id="files" name="files" accept=".mp4,.avi,.mov,.mkv" multiple>
                                <small class="form-text text-muted">Recommended: Name your files as "HOME TEAM vs AWAY TEAM MDX.mp4" for automatic team detection</small>
                                <div class="selected-files mt-2" id="selectedFilesList"></div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="excel_file" class="form-label">Player Database</label>
                            <div class="input-group">
                                <select class="form-select" id="use_default_excel" name="use_default_excel">
                                    <option value="1" selected>Use Default Excel File</option>
                                    <option value="0">Upload Custom Excel File</option>
                                </select>
                                <button class="btn btn-outline-secondary" type="button" id="toggle-excel-upload">Change</button>
                            </div>
                            {% if not teams %}
                                <small class="text-danger">Default Excel file not found or has no team sheets!</small>
                            {% endif %}
                        </div>
                        
                        <div class="mb-3" id="custom-excel-upload" style="display: none;">
                            <label for="excel_file" class="form-label">Upload Custom Player Database</label>
                            <input type="file" class="form-control" id="excel_file" name="excel_file" accept=".xlsx,.xls">
                            <small class="form-text text-muted">Excel file with team sheets. Each team should have its own sheet named exactly like the team name.</small>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">Add to Processing Queue</button>
                        </div>
                    </form>
                </div>
                
                <!-- Queue Tab -->
                <div class="tab-pane fade" id="queue" role="tabpanel" aria-labelledby="queue-tab">
                    <div class="queue-summary mb-3">
                        <div class="row">
                            <div class="col">
                                <h5>Queue Status:</h5>
                                <div class="progress mb-2" style="height: 25px;">
                                    {% set pending_percent = (queue_status.pending / queue_status.total * 100) if queue_status.total > 0 else 0 %}
                                    {% set processing_percent = (queue_status.processing / queue_status.total * 100) if queue_status.total > 0 else 0 %}
                                    {% set completed_percent = (queue_status.completed / queue_status.total * 100) if queue_status.total > 0 else 0 %}
                                    {% set error_percent = (queue_status.error / queue_status.total * 100) if queue_status.total > 0 else 0 %}
                                    
                                    <div class="progress-bar bg-secondary" role="progressbar" style="width: {{ pending_percent }}%" 
                                         title="Pending: {{ queue_status.pending }}">{{ queue_status.pending }}</div>
                                    <div class="progress-bar bg-info" role="progressbar" style="width: {{ processing_percent }}%" 
                                         title="Processing: {{ queue_status.processing }}">{{ queue_status.processing }}</div>
                                    <div class="progress-bar bg-success" role="progressbar" style="width: {{ completed_percent }}%" 
                                         title="Completed: {{ queue_status.completed }}">{{ queue_status.completed }}</div>
                                    <div class="progress-bar bg-danger" role="progressbar" style="width: {{ error_percent }}%" 
                                         title="Error: {{ queue_status.error }}">{{ queue_status.error }}</div>
                                </div>
                                <div class="video-count">
                                    <span class="badge bg-secondary">{{ queue_status.pending }} Pending</span>
                                    <span class="badge bg-info">{{ queue_status.processing }} Processing</span>
                                    <span class="badge bg-success">{{ queue_status.completed }} Completed</span>
                                    <span class="badge bg-danger">{{ queue_status.error }} Errors</span>
                                </div>
                            </div>
                            <div class="col-md-auto">
                                <div class="d-grid gap-2">
                                    <a href="{{ url_for('batch_process') }}" class="btn btn-primary" id="processNextBtn" 
                                      {% if queue_status.processing >= 2 or queue_status.pending == 0 %}disabled{% endif %}>
                                        <i class="bi bi-play-fill"></i> Process Next
                                    </a>
                                    <a href="{{ url_for('batch_process_all') }}" class="btn btn-success" id="processAllBtn"
                                      {% if queue_status.processing >= 2 or queue_status.pending == 0 %}disabled{% endif %}>
                                        <i class="bi bi-play-fill"></i> Process All
                                    </a>
                                    <a href="{{ url_for('batch_processing') }}" class="btn btn-info" 
                                      {% if queue_status.total == 0 %}disabled{% endif %}>
                                        <i class="bi bi-eye"></i> View Progress
                                    </a>
                                    <a href="{{ url_for('batch_results_all') }}" class="btn btn-success" 
                                      {% if queue_status.completed == 0 %}disabled{% endif %}>
                                        <i class="bi bi-file-earmark-text"></i> View All Results
                                    </a>
                                    <a href="{{ url_for('batch_clear_completed') }}" class="btn btn-outline-secondary" 
                                      {% if queue_status.completed == 0 %}disabled{% endif %}>
                                        <i class="bi bi-trash"></i> Clear Completed
                                    </a>
                                    <button type="button" class="btn btn-outline-success" 
                                      {% if queue_status.completed == 0 %}disabled{% endif %}
                                      data-bs-toggle="modal" data-bs-target="#saveToDatabaseModal">
                                        <i class="bi bi-database-add"></i> Save All to Database
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Configure Batch Processing -->
                    <div class="card mb-4">
                        <div class="card-header bg-secondary text-white">
                            <i class="bi bi-gear"></i> Batch Processing Settings
                        </div>
                        <div class="card-body">
                            <form action="{{ url_for('batch_configure') }}" method="post">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="max_parallel" class="form-label">Maximum Parallel Processing</label>
                                        <div class="input-group">
                                            <select class="form-select" id="max_parallel" name="max_parallel">
                                                <option value="1" {% if video_queue.max_parallel == 1 %}selected{% endif %}>1 video at a time</option>
                                                <option value="2" {% if video_queue.max_parallel == 2 %}selected{% endif %}>2 videos at a time</option>
                                                <option value="3" {% if video_queue.max_parallel == 3 %}selected{% endif %}>3 videos at a time</option>
                                                <option value="4" {% if video_queue.max_parallel == 4 %}selected{% endif %}>4 videos at a time</option>
                                                <option value="6" {% if video_queue.max_parallel == 6 %}selected{% endif %}>6 videos at a time</option>
                                                <option value="8" {% if video_queue.max_parallel == 8 %}selected{% endif %}>8 videos at a time</option>
                                            </select>
                                            <button type="submit" class="btn btn-primary">Apply</button>
                                        </div>
                                        <small class="text-muted">Higher values may use more system resources.</small>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    {% if videos %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Filename</th>
                                        <th>Status</th>
                                        <th>Teams</th>
                                        <th>Added</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for video in videos %}
                                        <tr>
                                            <td>{{ loop.index }}</td>
                                            <td>{{ video.filename }}</td>
                                            <td>
                                                {% if video.status == 'pending' %}
                                                    <span class="badge status-badge pending">Pending</span>
                                                {% elif video.status == 'processing' %}
                                                    <span class="badge status-badge processing">Processing</span>
                                                {% elif video.status == 'completed' %}
                                                    <span class="badge status-badge completed">Completed</span>
                                                {% elif video.status == 'error' %}
                                                    <span class="badge status-badge error" title="{{ video.error }}">Error</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if video.home_team and video.away_team %}
                                                    {{ video.home_team }} vs {{ video.away_team }}
                                                    {% if video.match_day %}
                                                    ({{ video.match_day }})
                                                    {% endif %}
                                                {% else %}
                                                    Auto-detect
                                                {% endif %}
                                            </td>
                                            <td>{{ video.added_at }}</td>
                                            <td class="action-buttons">
                                                {% if video.status == 'pending' %}
                                                    <button type="button" class="btn btn-outline-primary btn-sm" title="Edit Details" 
                                                            data-bs-toggle="modal" data-bs-target="#editVideoModal{{ loop.index }}">
                                                        <i class="bi bi-pencil"></i>
                                                    </button>
                                                    <a href="{{ url_for('batch_remove', video_id=video.id) }}" class="btn btn-outline-danger btn-sm" title="Remove">
                                                        <i class="bi bi-x-lg"></i>
                                                    </a>
                                                {% elif video.status == 'completed' %}
                                                    <a href="{{ url_for('batch_results', video_id=video.id) }}" class="btn btn-outline-primary btn-sm" title="View Results">
                                                        <i class="bi bi-eye"></i>
                                                    </a>
                                                    <a href="{{ url_for('batch_remove', video_id=video.id) }}" class="btn btn-outline-danger btn-sm" title="Remove">
                                                        <i class="bi bi-x-lg"></i>
                                                    </a>
                                                {% elif video.status == 'error' %}
                                                    <a href="{{ url_for('batch_remove', video_id=video.id) }}" class="btn btn-outline-danger btn-sm" title="Remove">
                                                        <i class="bi bi-x-lg"></i>
                                                    </a>
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="alert alert-info">
                            No videos in the queue. Add videos using the Upload Videos tab.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Edit Video Modals -->
    {% for video in videos %}
        {% if video.status == 'pending' %}
            <div class="modal fade" id="editVideoModal{{ loop.index }}" tabindex="-1" aria-labelledby="editVideoModalLabel{{ loop.index }}" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <form action="{{ url_for('batch_edit_video', video_id=video.id) }}" method="post">
                            <div class="modal-header">
                                <h5 class="modal-title" id="editVideoModalLabel{{ loop.index }}">Edit Video Details</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label class="form-label">Filename</label>
                                    <input type="text" class="form-control" value="{{ video.filename }}" id="filename{{ loop.index }}" disabled>
                                </div>
                                <div class="mb-3">
                                    <label for="home_team{{ loop.index }}" class="form-label">Home Team</label>
                                    <select class="form-select" id="home_team{{ loop.index }}" name="home_team">
                                        <option value="">Auto-detect from filename</option>
                                        {% for team in teams %}
                                            <option value="{{ team }}" {% if video.home_team == team %}selected{% endif %}>{{ team }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="away_team{{ loop.index }}" class="form-label">Away Team</label>
                                    <select class="form-select" id="away_team{{ loop.index }}" name="away_team">
                                        <option value="">Auto-detect from filename</option>
                                        {% for team in teams %}
                                            <option value="{{ team }}" {% if video.away_team == team %}selected{% endif %}>{{ team }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="match_day{{ loop.index }}" class="form-label">Match Day</label>
                                    <select class="form-select" id="match_day{{ loop.index }}" name="match_day">
                                        <option value="">Auto-detect from filename</option>
                                        {% for md in range(1, 39) %}
                                            <option value="MD{{ md }}" {% if video.match_day == 'MD' ~ md %}selected{% endif %}>MD{{ md }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="mb-2">
                                    <button type="button" class="btn btn-outline-secondary btn-sm" 
                                            id="detectButton{{ loop.index }}">Detect from Filename</button>
                                    <div id="detectionResult{{ loop.index }}" class="mt-2 small text-muted"></div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="submit" class="btn btn-primary">Save Changes</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        {% endif %}
    {% endfor %}
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Activate the correct tab based on URL hash
        document.addEventListener('DOMContentLoaded', function() {
            if (window.location.hash === '#queue') {
                const queueTab = document.getElementById('queue-tab');
                const bsQueueTab = new bootstrap.Tab(queueTab);
                bsQueueTab.show();
            }
            
            // Check URL parameters for actions
            const urlParams = new URLSearchParams(window.location.search);
            const action = urlParams.get('action');
            
            // Open save to database modal if action is specified
            if (action === 'save_to_database') {
                const queueTab = document.getElementById('queue-tab');
                const bsQueueTab = new bootstrap.Tab(queueTab);
                bsQueueTab.show();
                
                // Show the modal with a small delay to ensure tab is active
                setTimeout(function() {
                    const saveToDatabaseModal = new bootstrap.Modal(document.getElementById('saveToDatabaseModal'));
                    saveToDatabaseModal.show();
                }, 300);
            }
        });
        
        // Toggle custom Excel upload visibility
        document.getElementById('toggle-excel-upload').addEventListener('click', function() {
            const selectEl = document.getElementById('use_default_excel');
            const uploadDiv = document.getElementById('custom-excel-upload');
            
            if (selectEl.value === "1") {
                selectEl.value = "0";
                uploadDiv.style.display = "block";
            } else {
                selectEl.value = "1";
                uploadDiv.style.display = "none";
            }
        });
        
        // Also listen for select change
        document.getElementById('use_default_excel').addEventListener('change', function() {
            const uploadDiv = document.getElementById('custom-excel-upload');
            if (this.value === "0") {
                uploadDiv.style.display = "block";
            } else {
                uploadDiv.style.display = "none";
            }
        });
        
        // Show selected files
        document.getElementById('files').addEventListener('change', function() {
            const filesList = document.getElementById('selectedFilesList');
            filesList.innerHTML = '';
            
            if (this.files.length > 0) {
                const fileCount = document.createElement('div');
                fileCount.className = 'alert alert-info mt-2';
                fileCount.textContent = `Selected ${this.files.length} file(s):`;
                filesList.appendChild(fileCount);
                
                const list = document.createElement('ul');
                list.className = 'list-group';
                
                for (let i = 0; i < this.files.length; i++) {
                    const item = document.createElement('li');
                    item.className = 'list-group-item';
                    item.textContent = this.files[i].name;
                    list.appendChild(item);
                }
                
                filesList.appendChild(list);
            }
        });
        
        // Auto-reload queue status when processing
        {% if queue_status.processing %}
            let statusCheckTimer = setInterval(function() {
                fetch('{{ url_for("batch_status") }}')
                    .then(response => response.json())
                    .then(data => {
                        if (!data.is_processing) {
                            // If no longer processing, reload the page
                            clearInterval(statusCheckTimer);
                            window.location.reload();
                        }
                    })
                    .catch(error => console.error('Error checking status:', error));
            }, 5000); // Check every 5 seconds
        {% endif %}
        
        // Set up auto-processing for "Process All" button
        document.getElementById('processAllBtn').addEventListener('click', function(e) {
            // Don't prevent default - let the first request go through
            
            // Get the process next button
            const processNextButton = document.getElementById('processNextBtn');
            
            // Set up an interval to trigger parallel processing (up to 2 videos simultaneously)
            let autoProcessTimer = setInterval(function() {
                fetch('{{ url_for("batch_status") }}')
                    .then(response => response.json())
                    .then(data => {
                        // If still have pending videos and processing less than 2 videos, start a new one
                        if (data.pending > 0 && data.processing < 2) {
                            processNextButton.click();
                        } else if (data.pending === 0 && data.processing === 0) {
                            // No more pending videos and nothing processing, stop checking
                            clearInterval(autoProcessTimer);
                        }
                    })
                    .catch(error => {
                        console.error('Error checking status:', error);
                        clearInterval(autoProcessTimer);
                    });
            }, 2000); // Check every 2 seconds
        });
        
        // Add event listeners for detection buttons
        {% for video in videos %}
            {% if video.status == 'pending' %}
                // Get the button and modal elements
                const detectButton{{ loop.index }} = document.getElementById('detectButton{{ loop.index }}');
                const homeTeamSelect{{ loop.index }} = document.getElementById('home_team{{ loop.index }}');
                const awayTeamSelect{{ loop.index }} = document.getElementById('away_team{{ loop.index }}');
                const matchDaySelect{{ loop.index }} = document.getElementById('match_day{{ loop.index }}');
                const filename{{ loop.index }} = document.getElementById('filename{{ loop.index }}').value;
                const detectionResult{{ loop.index }} = document.getElementById('detectionResult{{ loop.index }}');
                
                // Setup modal event handler
                const modal{{ loop.index }} = document.getElementById('editVideoModal{{ loop.index }}');
                modal{{ loop.index }}.addEventListener('show.bs.modal', function() {
                    // Auto-detect on modal open
                    detectFromFilename(
                        filename{{ loop.index }}, 
                        homeTeamSelect{{ loop.index }}, 
                        awayTeamSelect{{ loop.index }}, 
                        matchDaySelect{{ loop.index }},
                        detectionResult{{ loop.index }}
                    );
                });
                
                // Setup detection button event handler
                if (detectButton{{ loop.index }}) {
                    detectButton{{ loop.index }}.addEventListener('click', function() {
                        detectFromFilename(
                            filename{{ loop.index }}, 
                            homeTeamSelect{{ loop.index }}, 
                            awayTeamSelect{{ loop.index }}, 
                            matchDaySelect{{ loop.index }},
                            detectionResult{{ loop.index }}
                        );
                    });
                }
            {% endif %}
        {% endfor %}
        
        // Function to detect team names and match day from filename
        function detectFromFilename(filename, homeTeamSelect, awayTeamSelect, matchDaySelect, resultElement) {
            // Ensure all elements exist
            if (!filename || !homeTeamSelect || !awayTeamSelect || !matchDaySelect) {
                console.error('Missing required elements for detection');
                return;
            }
            
            // Set the result element to show processing
            if (resultElement) {
                resultElement.innerHTML = 'Detecting from filename...';
            }
            
            // Replace underscores with spaces for better matching
            const cleanedFilename = filename.replace(/_/g, ' ');
            
            // Extract team names - looking for pattern like "TEAM1 VS TEAM2 MDx.mp4"
            // Support both uppercase "VS" and lowercase "vs"
            const vsPattern = /(.+?)\s+(?:VS|vs)\s+(.+?)(?:\s+(?:MD|md)\d+|\.\w+$)/i;
            
            // Support both uppercase "MD" and lowercase "md" for match day
            const mdPattern = /(?:MD|md)(\d+)/i;
            
            // Get matches
            const vsMatch = cleanedFilename.match(vsPattern);
            const mdMatch = cleanedFilename.match(mdPattern);
            
            let detectionResults = [];
            
            // Process home team
            if (vsMatch && vsMatch[1]) {
                const homeTeamRaw = vsMatch[1].trim();
                detectionResults.push(`Home: ${homeTeamRaw}`);
                
                // Find the closest match in the select options
                findBestSelectOption(homeTeamSelect, homeTeamRaw);
            }
            
            // Process away team
            if (vsMatch && vsMatch[2]) {
                const awayTeamRaw = vsMatch[2].trim();
                detectionResults.push(`Away: ${awayTeamRaw}`);
                
                // Find the closest match in the select options
                findBestSelectOption(awayTeamSelect, awayTeamRaw);
            }
            
            // Process match day
            if (mdMatch && mdMatch[1]) {
                const matchDayValue = 'MD' + mdMatch[1];
                detectionResults.push(`Match Day: ${matchDayValue}`);
                
                // Find exact match for match day
                for (let i = 0; i < matchDaySelect.options.length; i++) {
                    if (matchDaySelect.options[i].value === matchDayValue) {
                        matchDaySelect.selectedIndex = i;
                        break;
                    }
                }
            }
            
            // Special case for filenames with no matches - try more aggressive parsing
            if (detectionResults.length === 0) {
                // Check if we have any underscores or spaces that might separate parts
                const parts = filename
                    .replace(/\.\w+$/, '') // Remove extension
                    .replace(/_/g, ' ') // Replace underscores with spaces
                    .split(/\s+/); // Split by whitespace
                
                if (parts.length >= 3) {
                    // Try to find "vs" or "VS" to separate home and away teams
                    const vsIndex = parts.findIndex(part => 
                        part.toLowerCase() === 'vs' || part.toLowerCase() === 'v');
                    
                    if (vsIndex > 0 && vsIndex < parts.length - 1) {
                        // Get home team (all parts before vs)
                        const homeTeamRaw = parts.slice(0, vsIndex).join(' ');
                        detectionResults.push(`Home: ${homeTeamRaw}`);
                        findBestSelectOption(homeTeamSelect, homeTeamRaw);
                        
                        // Get away team (all parts after vs, except potential match day)
                        const remainingParts = parts.slice(vsIndex + 1);
                        const mdIndex = remainingParts.findIndex(part => 
                            part.toLowerCase().startsWith('md'));
                        
                        let awayTeamRaw;
                        if (mdIndex > 0) {
                            awayTeamRaw = remainingParts.slice(0, mdIndex).join(' ');
                        } else {
                            awayTeamRaw = remainingParts.join(' ');
                        }
                        
                        detectionResults.push(`Away: ${awayTeamRaw}`);
                        findBestSelectOption(awayTeamSelect, awayTeamRaw);
                    }
                }
            }
            
            // Update detection results display
            if (resultElement && detectionResults.length > 0) {
                resultElement.innerHTML = 'Detected: ' + detectionResults.join(', ');
            } else if (resultElement) {
                resultElement.innerHTML = 'Could not detect values from filename';
            }
        }
        
        // Function to find the best matching option in a select element
        function findBestSelectOption(selectElement, searchText) {
            if (!selectElement || !searchText) return false;
            
            // Clean and normalize search text
            searchText = searchText.toUpperCase()
                .replace(/^THE\s+/, '') // Remove leading "THE"
                .replace(/\s+FC$/, '') // Remove trailing "FC"
                .trim();
            
            console.log('Searching for:', searchText);
            
            // First try exact match
            for (let i = 0; i < selectElement.options.length; i++) {
                const optionText = selectElement.options[i].text.toUpperCase();
                if (optionText === searchText) {
                    selectElement.selectedIndex = i;
                    console.log('Exact match found:', optionText);
                    return true;
                }
            }
            
            // Try contains match
            for (let i = 0; i < selectElement.options.length; i++) {
                const optionText = selectElement.options[i].text.toUpperCase();
                if (searchText.includes(optionText) || optionText.includes(searchText)) {
                    selectElement.selectedIndex = i;
                    console.log('Contains match found:', optionText);
                    return true;
                }
            }
            
            // Try word-by-word match (check if all words in the option are in the search text)
            for (let i = 0; i < selectElement.options.length; i++) {
                const optionText = selectElement.options[i].text.toUpperCase();
                const optionWords = optionText.split(/\s+/);
                
                // Check if all words in option are in the search text
                if (optionWords.length > 1 && optionWords.every(word => searchText.includes(word))) {
                    selectElement.selectedIndex = i;
                    console.log('Word match found:', optionText);
                    return true;
                }
                
                // Check if all words in search text are in the option
                const searchWords = searchText.split(/\s+/);
                if (searchWords.length > 1 && searchWords.every(word => optionText.includes(word))) {
                    selectElement.selectedIndex = i;
                    console.log('Word match found (reverse):', optionText);
                    return true;
                }
            }
            
            // Try fuzzy match based on common abbreviations
            const abbrevMap = {
                'UNITED': 'UTD',
                'MANCHESTER': 'MAN',
                'TOTTENHAM HOTSPUR': 'SPURS',
                'HOTSPUR': 'SPURS', 
                'TOTTENHAM': 'SPURS',
                'WOLVERHAMPTON': 'WOLVES',
                'WOLVERHAMPTON WANDERERS': 'WOLVES',
                'WANDERERS': 'WOLVES',
                'CITY': 'CITY',
                'PALACE': 'PALACE',
                'CRYSTAL': 'CRYSTAL',
                'ARSENAL': 'AFC',
                'LIVERPOOL': 'LFC',
                'CHELSEA': 'CFC',
                'MANCHESTER UNITED': 'MUFC',
                'MANCHESTER CITY': 'MCFC',
                'ASTON VILLA': 'AVFC',
                'EVERTON': 'EFC',
                'LEICESTER': 'LCFC',
                'LEICESTER CITY': 'LCFC',
                'NEWCASTLE': 'NUFC',
                'NEWCASTLE UNITED': 'NUFC',
                'BRIGHTON': 'BHAFC',
                'BRIGHTON AND HOVE ALBION': 'BHAFC',
                'SOUTHAMPTON': 'SFC',
                'WESTHAM': 'WEST HAM',
                'WEST HAM': 'WHU',
                'NOTTINGHAM': 'NFFC',
                'NOTTINGHAM FOREST': 'NFFC',
                'BRENTFORD': 'BFC',
                'FULHAM': 'FFC',
                'BOURNEMOUTH': 'AFCB',
                'MOHUN BAGAN': 'MBSG',
                'MOHUNBAGAN': 'MBSG',
                'MOHUN BAGAN SG': 'MBSG',
                'MOHUNBAGAN SG': 'MBSG'
            };
            
            // Check abbreviations in both directions
            for (let i = 0; i < selectElement.options.length; i++) {
                const optionText = selectElement.options[i].text.toUpperCase();
                
                // Check all abbreviation mappings
                for (const [full, abbrev] of Object.entries(abbrevMap)) {
                    // Check if full name in option and abbreviation in search
                    if (optionText.includes(full) && searchText.includes(abbrev)) {
                        selectElement.selectedIndex = i;
                        console.log('Abbrev match found:', optionText, 'for', searchText);
                        return true;
                    }
                    
                    // Check if abbreviation in option and full name in search
                    if (optionText.includes(abbrev) && searchText.includes(full)) {
                        selectElement.selectedIndex = i;
                        console.log('Abbrev match found (reverse):', optionText, 'for', searchText);
                        return true;
                    }
                }
            }
            
            // Partial word matches - most aggressive matching
            // This will match if a significant part of the team name matches
            for (let i = 0; i < selectElement.options.length; i++) {
                const optionText = selectElement.options[i].text.toUpperCase();
                
                // Ignore very short option texts to avoid false positives
                if (optionText.length < 3) continue;
                
                // Check if a significant part of the option text is in search text
                const optionWords = optionText.split(/\s+/);
                for (const word of optionWords) {
                    // Only check words that are reasonably long
                    if (word.length >= 5 && searchText.includes(word)) {
                        selectElement.selectedIndex = i;
                        console.log('Partial word match found:', word, 'in', optionText);
                        return true;
                    }
                }
                
                // Check if a significant part of the search text is in option text
                const searchWords = searchText.split(/\s+/);
                for (const word of searchWords) {
                    // Only check words that are reasonably long
                    if (word.length >= 5 && optionText.includes(word)) {
                        selectElement.selectedIndex = i;
                        console.log('Partial word match found (reverse):', word, 'in', searchText);
                        return true;
                    }
                }
            }
            
            // If no match found, leave the default "Auto-detect" option selected
            console.log('No match found for:', searchText);
            return false;
        }
    </script>
    
    <!-- Save to Database Modal -->
    <div class="modal fade" id="saveToDatabaseModal" tabindex="-1" aria-labelledby="saveToDatabaseModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form action="{{ url_for('batch_save_all_to_database') }}" method="post">
                    <div class="modal-header">
                        <h5 class="modal-title" id="saveToDatabaseModalLabel">Save All Results to Database</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>This will save all completed video results to the database. For each video, match records will be created and player appearances will be recorded.</p>
                        
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> 
                            <strong>Note:</strong> Players detected in videos but not found in team squads will be saved to a separate "Unmatched Players" list. 
                            They will <strong>not</strong> be added to the official team squads.
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> All completed videos: {{ queue_status.completed }}
                        </div>
                        
                        <h6>Completed Videos</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Filename</th>
                                        <th>Teams</th>
                                        <th>Match Day</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for video in videos %}
                                        {% if video.status == 'completed' %}
                                            <tr>
                                                <td>{{ video.filename }}</td>
                                                <td>
                                                    {% if video_queue.results[video.id].home_team and video_queue.results[video.id].away_team %}
                                                        {{ video_queue.results[video.id].home_team }} vs {{ video_queue.results[video.id].away_team }}
                                                    {% else %}
                                                        Unknown
                                                    {% endif %}
                                                </td>
                                                <td>{{ video_queue.results[video.id].match_day }}</td>
                                            </tr>
                                            <input type="hidden" name="video_ids" value="{{ video.id }}">
                                            
                                            {% if video_queue.results[video.id].unmatched_home or video_queue.results[video.id].unmatched_away %}
                                                <tr>
                                                    <td colspan="3" class="bg-light">
                                                        <div class="alert alert-warning mb-0">
                                                            <i class="bi bi-exclamation-triangle-fill"></i> 
                                                            <strong>Unmatched Players:</strong>
                                                            {% set home_count = video_queue.results[video.id].unmatched_home|length %}
                                                            {% set away_count = video_queue.results[video.id].unmatched_away|length %}
                                                            
                                                            {% if home_count > 0 %}
                                                                {{ home_count }} for {{ video_queue.results[video.id].home_team }}
                                                            {% endif %}
                                                            
                                                            {% if home_count > 0 and away_count > 0 %}
                                                                and 
                                                            {% endif %}
                                                            
                                                            {% if away_count > 0 %}
                                                                {{ away_count }} for {{ video_queue.results[video.id].away_team }}
                                                            {% endif %}
                                                            
                                                            will be added to the unmatched players list.
                                                        </div>
                                                    </td>
                                                </tr>
                                            {% endif %}
                                        {% endif %}
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-success">Save All to Database</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</body>
</html> 